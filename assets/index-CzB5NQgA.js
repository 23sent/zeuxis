var wt=Object.defineProperty;var _t=(u,t,e)=>t in u?wt(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var h=(u,t,e)=>(_t(u,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class p{constructor(t=0,e=0){h(this,"x");h(this,"y");t instanceof p?(this.x=t.x,this.y=t.y):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0):(this.x=t,this.y=e)}add(t){return t instanceof p?new p(this.x+t.x,this.y+t.y):new p(this.x+t,this.y+t)}substract(t){return t instanceof p?new p(this.x-t.x,this.y-t.y):new p(this.x-t,this.y-t)}multiply(t){return t instanceof p?new p(this.x*t.x,this.y*t.y):new p(this.x*t,this.y*t)}equals(t){return this.x===t.x&&this.y===t.y}dot(t){return this.x*t.x+this.y*t.y}distance(t){return this.substract(t).magnitude}normalized(){return this.multiply(1/this.magnitude)}angle(t){const e=Math.sqrt(this.magnitudeSq*t.magnitudeSq);return Math.acos(this.dot(t)/e)}get magnitude(){return Math.sqrt(this.dot(this))}get magnitudeSq(){return this.dot(this)}static get Zero(){return Object.freeze(new p(0,0))}static get One(){return Object.freeze(new p(1,1))}static get Up(){return Object.freeze(new p(0,1))}static get Down(){return Object.freeze(new p(0,-1))}static get Left(){return Object.freeze(new p(-1,0))}static get Right(){return Object.freeze(new p(1,0))}}const z=class z{constructor(t){h(this,"ROWS",2);h(this,"COLS",2);h(this,"_data",new Float64Array(4));t instanceof Array?this.setData(t.flat()):t instanceof z?this.setData(t._data):this.setData(z.identity._data)}setData(t){for(let e=0;e<t.length&&e<this._data.length;e++)this._data[e]=t[e]}get(t,e){return this._data[t*this.COLS+e]}set(t,e,i){this._data[t*this.COLS+e]=i}get length(){return this._data.length}get transpose(){return z.Transpose(this)}multiply(t){return t instanceof z?z.Multiply(this,t):z.MultiplyScalar(this,t)}determinant(){return this._data[0]*this._data[3]-this._data[1]*this._data[2]}inverse(){const t=this.determinant();if(t===0)return new z;const e=1/t;return new z([+this._data[3]*e,-this._data[1]*e,-this._data[2]*e,+this._data[0]*e])}minor(){return new z([this._data[3],this._data[2],this._data[1],this._data[0]])}static Multiply(t,e){if(t.COLS!==e.ROWS)throw new Error("Invalid matrix multiplication.");const i=new z;for(let s=0;s<i.COLS;s++)for(let n=0;n<i.ROWS;n++){let a=0;for(let r=0;r<t.COLS;r++)a+=t.get(n,r)*e.get(r,s);i.set(n,s,a)}return i}static MultiplyScalar(t,e){const i=new z;for(let s=0;s<t.ROWS*t.COLS;s++)i._data[s]=t._data[s]*e;return i}static Transpose(t){const e=new z;for(let i=0;i<t.ROWS*t.COLS;i++){let s=Math.floor(i/t.ROWS),n=i%t.ROWS;e._data[i]=t._data[t.COLS*n+s]}return e}};h(z,"identity",Object.freeze(new z([[1,0],[0,1]])));let $=z;const O=class O{constructor(t){h(this,"ROWS",3);h(this,"COLS",3);h(this,"_data",new Float32Array(9));t instanceof Array?this.setData(t.flat()):t instanceof O?this.setData(t._data):this.setData(O.identity._data)}setData(t){for(let e=0;e<t.length&&e<this._data.length;e++)this._data[e]=t[e]}get(t,e){return this._data[t*this.COLS+e]}set(t,e,i){this._data[t*this.COLS+e]=i}get length(){return this._data.length}get transpose(){return O.Transpose(this)}multiply(t){return t instanceof O?O.Multiply(this,t):O.MultiplyScalar(this,t)}determinant(){const t=this.get(1,1)*this.get(2,2)-this.get(1,2)*this.get(2,1),e=this.get(1,0)*this.get(2,2)-this.get(1,2)*this.get(2,0),i=this.get(1,0)*this.get(2,1)-this.get(1,1)*this.get(2,0);return this.get(0,0)*t-this.get(0,1)*e+this.get(0,2)*i}inverse(){const t=this.determinant();if(t===0)return new O;const e=1/t,i=this.get(1,1)*this.get(2,2)-this.get(1,2)*this.get(2,1),s=this.get(1,0)*this.get(2,2)-this.get(1,2)*this.get(2,0),n=this.get(1,0)*this.get(2,1)-this.get(1,1)*this.get(2,0),a=this.get(0,1)*this.get(2,2)-this.get(0,2)*this.get(2,1),r=this.get(0,0)*this.get(2,2)-this.get(0,2)*this.get(2,0),c=this.get(0,0)*this.get(2,1)-this.get(0,1)*this.get(2,0),o=this.get(0,1)*this.get(1,2)-this.get(0,2)*this.get(1,1),l=this.get(0,0)*this.get(1,2)-this.get(0,2)*this.get(1,0),f=this.get(0,0)*this.get(1,1)-this.get(0,1)*this.get(1,0);return new O([+s*e,-i*e,+n*e,-a*e,+r*e,-c*e,+o*e,-l*e,+f*e])}multiplyVec3(t){const e=t.x,i=t.y,s=t.z;return new d(this._data[0]*e+this._data[4]*i+this._data[8]*s,this._data[1]*e+this._data[5]*i+this._data[9]*s,this._data[2]*e+this._data[6]*i+this._data[10]*s)}static Multiply(t,e){if(t.COLS!==e.ROWS)throw new Error("Invalid matrix multiplication.");const i=new O;for(let s=0;s<i.COLS;s++)for(let n=0;n<i.ROWS;n++){let a=0;for(let r=0;r<t.COLS;r++)a+=t.get(n,r)*e.get(s,r);i.set(n,s,a)}return i}static MultiplyScalar(t,e){const i=new O;for(let s=0;s<t.ROWS*t.COLS;s++)i._data[s]=t._data[s]*e;return i}static Transpose(t){const e=new O;for(let i=0;i<t.ROWS*t.COLS;i++){let s=Math.floor(i/t.ROWS),n=i%t.ROWS;e._data[i]=t._data[t.COLS*n+s]}return e}};h(O,"identity",Object.freeze(new O([[1,0,0],[0,1,0],[0,0,1]])));let Q=O;const g=class g{constructor(t){h(this,"ROWS",4);h(this,"COLS",4);h(this,"_data",new Float32Array(16));t instanceof Array?this.setData(t.flat()):t instanceof g?this.setData(t._data):this.setData(g.identity._data)}setData(t){for(let e=0;e<t.length&&e<this._data.length;e++)this._data[e]=t[e]}get(t,e){return this._data[t*this.COLS+e]}set(t,e,i){this._data[t*this.COLS+e]=i}get length(){return this._data.length}transpose(){return g.Transpose(this)}multiply(t){return t instanceof g?g.Multiply(this,t):g.MultiplyScalar(this,t)}determinant(){const t=this.get(2,0)*this.get(3,1)-this.get(2,1)*this.get(3,0),e=this.get(2,0)*this.get(3,2)-this.get(2,2)*this.get(3,0),i=this.get(2,0)*this.get(3,3)-this.get(2,3)*this.get(3,0),s=this.get(2,1)*this.get(3,2)-this.get(2,2)*this.get(3,1),n=this.get(2,1)*this.get(3,3)-this.get(2,3)*this.get(3,1),a=this.get(2,2)*this.get(3,3)-this.get(2,3)*this.get(3,2),r=this.get(1,1)*a-this.get(1,2)*n+this.get(1,3)*s,c=this.get(1,0)*a-this.get(1,2)*i+this.get(1,3)*e,o=this.get(1,0)*n-this.get(1,1)*i+this.get(1,3)*t,l=this.get(1,0)*s-this.get(1,1)*e+this.get(1,2)*t;return this.get(0,0)*r-this.get(0,1)*c+this.get(0,2)*o-this.get(0,3)*l}inverse(){const t=this.determinant();if(t===0)return new g;const e=1/t,i=this._data[9]*this._data[14]-this._data[10]*this._data[13],s=this._data[9]*this._data[15]-this._data[11]*this._data[13],n=this._data[10]*this._data[15]-this._data[11]*this._data[14],a=this._data[8]*this._data[14]-this._data[10]*this._data[12],r=this._data[8]*this._data[15]-this._data[11]*this._data[12],c=this._data[8]*this._data[13]-this._data[9]*this._data[12],o=this._data[5]*this._data[14]-this._data[6]*this._data[13],l=this._data[5]*this._data[15]-this._data[7]*this._data[13],f=this._data[6]*this._data[15]-this._data[7]*this._data[14],w=this._data[4]*this._data[14]-this._data[6]*this._data[12],m=this._data[4]*this._data[15]-this._data[7]*this._data[12],M=this._data[4]*this._data[13]-this._data[5]*this._data[12],C=this._data[5]*this._data[10]-this._data[6]*this._data[9],R=this._data[5]*this._data[11]-this._data[7]*this._data[9],j=this._data[6]*this._data[11]-this._data[7]*this._data[10],b=this._data[4]*this._data[10]-this._data[6]*this._data[8],E=this._data[4]*this._data[11]-this._data[7]*this._data[8],X=this._data[4]*this._data[9]-this._data[5]*this._data[8],V=this._data[5]*n-this._data[6]*s+this._data[7]*i,v=this._data[4]*n-this._data[6]*r+this._data[7]*a,tt=this._data[4]*s-this._data[5]*r+this._data[7]*c,et=this._data[4]*i-this._data[5]*a+this._data[6]*c,st=this._data[1]*n-this._data[2]*s+this._data[3]*i,it=this._data[0]*n-this._data[2]*r+this._data[3]*a,nt=this._data[0]*s-this._data[1]*r+this._data[3]*c,at=this._data[0]*i-this._data[1]*a+this._data[2]*c,rt=this._data[1]*f-this._data[2]*l+this._data[3]*o,ht=this._data[0]*f-this._data[2]*m+this._data[3]*w,ot=this._data[0]*l-this._data[1]*m+this._data[3]*M,ct=this._data[0]*o-this._data[1]*w+this._data[2]*M,dt=this._data[1]*j-this._data[2]*R+this._data[3]*C,lt=this._data[0]*j-this._data[2]*E+this._data[3]*b,ut=this._data[0]*R-this._data[1]*E+this._data[3]*X,ft=this._data[0]*C-this._data[1]*b+this._data[2]*X;return new g([+V*e,-st*e,+rt*e,-dt*e,-v*e,+it*e,-ht*e,+lt*e,+tt*e,-nt*e,+ot*e,-ut*e,-et*e,+at*e,-ct*e,+ft*e])}translate(t,e,i){const s=new g(this);return t instanceof d?(i=t.z,e=t.y,t=t.x):(e=e??0,i=i??0),s._data[12]+=this._data[0]*t+this._data[4]*e+this._data[8]*i,s._data[13]+=this._data[1]*t+this._data[5]*e+this._data[9]*i,s._data[14]+=this._data[2]*t+this._data[6]*e+this._data[10]*i,s._data[15]+=this._data[3]*t+this._data[7]*e+this._data[11]*i,s}scale(t,e,i){const s=new g(this);return t instanceof d?(i=t.z,e=t.y,t=t.x):(e=e??0,i=i??0),s._data[0]*=t,s._data[1]*=t,s._data[2]*=t,s._data[3]*=t,s._data[4]*=e,s._data[5]*=e,s._data[6]*=e,s._data[7]*=e,s._data[8]*=i,s._data[9]*=i,s._data[10]*=i,s._data[11]*=i,s}static Multiply(t,e){const i=new g;for(let s=0;s<4;s++)for(let n=0;n<4;n++){let a=0;for(let r=0;r<4;r++)a+=t._data[4*s+r]*e._data[4*r+n];i._data[4*s+n]=a}return i}static MultiplyScalar(t,e){const i=new g;for(let s=0;s<t.ROWS*t.COLS;s++)i._data[s]=t._data[s]*e;return i}static Transpose(t){const e=new g;for(let i=0;i<t.ROWS*t.COLS;i++){let s=Math.floor(i/t.ROWS),n=i%t.ROWS;e._data[i]=t._data[t.COLS*n+s]}return e}static fromQuaternion(t){const e=t.x*t.x,i=t.y*t.y,s=t.z*t.z,n=t.x*t.z,a=t.x*t.y,r=t.y*t.z,c=t.w*t.x,o=t.w*t.y,l=t.w*t.z;return new g([[1-2*(i+s),2*(a+l),2*(n-o),0],[2*(a-l),1-2*(e+s),2*(r+c),0],[2*(n+o),2*(r-c),1-2*(e+i),0],[0,0,0,1]])}static axisAngle(t,e){const i=t.normalized(),s=Math.cos(e),n=Math.sin(e),a=1-Math.cos(e),r=i.x,c=i.y,o=i.z;return new g([[a*(r*r)+s,a*r*c+n*o,a*r*o-n*c,0],[a*r*c-n*o,a*(c*c)+s,a*c*o+n*r,0],[a*r*o+n*c,a*c*o-n*r,a*(o*o)+s,0],[0,0,0,1]])}static ortho(t,e,i,s,n,a){const r=2/(e-t),c=2/(s-i),o=1/(a-n),l=(t+e)/(t-e),f=(s+i)/(i-s),w=n/(n-a);return new g([[r,0,0,0],[0,c,0,0],[0,0,o,0],[l,f,w,1]])}static perspective(t,e,i,s){const n=t*(Math.PI/180),a=1/Math.tan(n/2),r=a/e,c=s-i,o=r,l=a,f=s/c,w=-(s*i/c);return new g([[o,0,0,0],[0,l,0,0],[0,0,f,1],[0,0,w,0]])}};h(g,"identity",Object.freeze(new g([[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]])));let x=g;class _{constructor(t=0,e=0,i=0,s=0){h(this,"x");h(this,"y");h(this,"z");h(this,"w");t instanceof _?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):t instanceof d?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=1):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0,this.w=t[4]||0):(this.x=t,this.y=e,this.z=i,this.w=s)}add(t){return t instanceof _?new _(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w):new _(this.x+t,this.y+t,this.z+t,this.w+t)}substract(t){return t instanceof _?new _(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w):new _(this.x-t,this.y-t,this.z-t,this.w-t)}multiply(t){if(t instanceof _)return new _(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w);if(t instanceof x){const e=this.x,i=this.y,s=this.z,n=this.w;return new _(t._data[0]*e+t._data[4]*i+t._data[8]*s+t._data[12]*n,t._data[1]*e+t._data[5]*i+t._data[9]*s+t._data[13]*n,t._data[2]*e+t._data[6]*i+t._data[10]*s+t._data[14]*n,t._data[3]*e+t._data[7]*i+t._data[11]*s+t._data[15]*n)}else return new _(this.x*t,this.y*t,this.z*t,this.w*t)}divide(t){return t instanceof _?new _(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w):new _(this.x/t,this.y/t,this.z/t,this.w/t)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}distance(t){return this.substract(t).magnitude}normalized(){return this.multiply(1/this.magnitude)}angle(t){const e=Math.sqrt(this.magnitudeSq*t.magnitudeSq);return Math.acos(this.dot(t)/e)}get magnitude(){return Math.sqrt(this.dot(this))}get magnitudeSq(){return this.dot(this)}static fromVector3(t,e=1){return new _(t.x,t.y,t.z,e)}}class d{constructor(t=0,e=0,i=0){h(this,"x");h(this,"y");h(this,"z");t instanceof p?(this.x=t.x,this.y=t.y,this.z=e):t instanceof d||t instanceof _?(this.x=t.x,this.y=t.y,this.z=t.z):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0):(this.x=t,this.y=e,this.z=i)}add(t){return t instanceof d?new d(this.x+t.x,this.y+t.y,this.z+t.z):new d(this.x+t,this.y+t,this.z+t)}substract(t){return t instanceof d?new d(this.x-t.x,this.y-t.y,this.z-t.z):new d(this.x-t,this.y-t,this.z-t)}multiply(t){return t instanceof d?new d(this.x*t.x,this.y*t.y,this.z*t.z):new d(this.x*t,this.y*t,this.z*t)}divide(t){return t instanceof d?new d(this.x/t.x,this.y/t.y,this.z/t.z):new d(this.x/t,this.y/t,this.z/t)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new d(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}distance(t){return this.substract(t).magnitude}normalized(){return this.multiply(1/this.magnitude)}angle(t){const e=Math.sqrt(this.magnitudeSq*t.magnitudeSq);return Math.acos(this.dot(t)/e)}toHomogeneous(t){return new _(t)}get magnitude(){return Math.sqrt(this.dot(this))}get magnitudeSq(){return this.dot(this)}static get Zero(){return Object.freeze(new d(0,0,0))}static get One(){return Object.freeze(new d(1,1,1))}static get Up(){return Object.freeze(new d(0,1,0))}static get Down(){return Object.freeze(new d(0,-1,0))}static get Left(){return Object.freeze(new d(-1,0,0))}static get Right(){return Object.freeze(new d(1,0,0))}static get Back(){return Object.freeze(new d(0,0,-1))}static get Forward(){return Object.freeze(new d(0,0,1))}}class A{constructor(t,e,i){h(this,"position");h(this,"texCoord");h(this,"normal");h(this,"_vsOutput");this.position=new d(t),e!==void 0&&(this.texCoord=new p(e)),i!==void 0&&(this.normal=new d(i))}}const D=class D{constructor(t,e){h(this,"verticies");h(this,"indicies");this.verticies=new Array(t),this.indicies=new Uint16Array(e)}static fromArrays(t,e){const i=new this(t.length,e.length);return i.verticies=t,i.indicies.set(e),i}getVertex(t){return this.verticies[this.indicies[t]]}};h(D,"QuadMesh",D.fromArrays([new A([.5,.5,0],[1,1]),new A([.5,-.5,0],[1,0]),new A([-.5,-.5,0],[0,0]),new A([-.5,.5,0],[0,1])],[0,1,3,1,2,3]));let T=D;class y{constructor(t=0,e=0,i=0,s=255){this.r=t,this.g=e,this.b=i,this.a=s}get red(){return this.r}get green(){return this.g}get blue(){return this.b}get alpha(){return this.a}set red(t){this.r=t}set green(t){this.g=t}set blue(t){this.b=t}set alpha(t){this.a=t}toVec4(){return new _(this.r,this.g,this.b,this.a)}toVec3(){return new d(this.r,this.g,this.b)}static get black(){return Object.freeze(new y(0,0,0))}static get white(){return Object.freeze(new y(255,255,255))}static get red(){return Object.freeze(new y(255,0,0))}static get green(){return Object.freeze(new y(0,255,0))}static get blue(){return Object.freeze(new y(0,0,255))}static fromVec(t,e){return t instanceof _?new y(t.x,t.y,t.z,e||t.w):new y(t.x,t.y,t.z,e)}}const F=class F{constructor(t=0,e=0,i=0,s=1){h(this,"x");h(this,"y");h(this,"z");h(this,"w");this.x=t,this.y=e,this.z=i,this.w=s}static fromEuler(t,e,i){let s;t instanceof d?(s=t.x,e=t.y,i=t.z):(s=t,e=e||0,i=i||0),s=s*(Math.PI/180),e=e*(Math.PI/180),i=i*(Math.PI/180);const n=Math.sin(s*.5),a=Math.cos(s*.5),r=Math.sin(e*.5),c=Math.cos(e*.5),o=Math.sin(i*.5),l=Math.cos(i*.5);return new F(n*c*l-a*r*o,a*r*l+n*c*o,a*c*o-n*r*l,a*c*l+n*r*o)}};h(F,"identity",Object.freeze(new F(0,0,0,1)));let P=F;var Z=(u=>(u[u.Orthographic=0]="Orthographic",u[u.Perspective=1]="Perspective",u))(Z||{});class q{constructor(t=1){h(this,"_projectionType");h(this,"_position",new d(0,0,0));h(this,"_rotation",new d(0,0,0));h(this,"_aspect",1);h(this,"_projection",new x);h(this,"_view",new x);h(this,"_viewProjectionMatrix",new x);this._projectionType=t,this._aspect=1,this.calculateProjectionMatrix(),this.calculateViewMatrix()}get position(){return this._position}set aspect(t){this._aspect=t,this.calculateProjectionMatrix()}calculateProjectionMatrix(){this._projectionType===1?this._projection=x.perspective(45,this._aspect,.1,100):this._projectionType===0&&(this._projection=x.ortho(-this._aspect,this._aspect,-1,1,-1,1*20)),this.calculateViewProjectionMatrix()}calculateViewMatrix(){const t=new x().translate(this._position),e=x.fromQuaternion(P.fromEuler(this._rotation)),i=t.multiply(e);this._view=i.inverse(),this.calculateViewProjectionMatrix()}calculateViewProjectionMatrix(){this._viewProjectionMatrix=this._view.multiply(this._projection)}setPosition(t){this._position=t,this.calculateViewMatrix()}setRotation(t){this._rotation=t,this.calculateViewMatrix()}getViewProjectionMatrix(){return this._viewProjectionMatrix}move(t){this._position=this._position.add(t),this.calculateViewMatrix()}rotate(t){this._rotation=this._rotation.add(t),this.calculateViewMatrix()}}h(q,"Types",Z);function mt(u,t,e,i){i=Math.max(1,Number(i.toFixed()));const s=new Uint8ClampedArray(u.length*i*i);for(let n=0;n<s.length;n+=4){const a=Math.floor(n/4),r=a%(t*i),c=Math.floor(a/(t*i)),o=Math.floor(r/i),f=(Math.floor(c/i)*t+o)*4;s[n+0]=u[f+0],s[n+1]=u[f+1],s[n+2]=u[f+2],s[n+3]=u[f+3]}return s}class G{vertexShader(t){return{clip_space_position:new _(t.position)}}fragmentShader(t){return{fragment_color:new y(0,0,0)}}}const S=new Array(1e4).fill(0).map(()=>({vertex:new A([0,0,0]),vsOutput:{clip_space_position:new _},ndc_position:new d,screen_space_position:new d}));class pt{constructor(t,e){h(this,"buffer",new Uint8ClampedArray);h(this,"zBuffer",new Float32Array);h(this,"shader",new G);h(this,"deltaTime",1);h(this,"lastTime",0);h(this,"fps",0);h(this,"frameCount",0);h(this,"elapsedTime",0);h(this,"WIREFRAME",!1);this.width=t,this.height=e,this.setViewportSize(t,e)}setViewportSize(t,e){this.width=t,this.height=e,this.buffer=new Uint8ClampedArray(t*e*4),this.zBuffer=new Float32Array(t*e),this.clearDepthBuffer()}clearDepthBuffer(){for(let t=0;t<this.zBuffer.length;t++)this.zBuffer[t]=1/0}clearBuffer(){for(let t=0;t<this.buffer.length;t++)this.buffer[t]=0}fillBuffer(t){for(let e=0;e<this.buffer.length;e+=4)this.buffer[e]=t.red,this.buffer[e+1]=t.green,this.buffer[e+2]=t.blue,this.buffer[e+3]=t.alpha}getBarycentricCoords(t,e,i,s){const n=e.substract(t),a=i.substract(t),r=s.substract(t),c=n.dot(n),o=n.dot(a),l=a.dot(a),f=r.dot(n),w=r.dot(a),m=c*l-o*o,M=(l*f-o*w)/m,C=(c*w-o*f)/m,R=1-M-C;return new d(R,M,C)}drawMesh(t){this.vertexShading(t.verticies);for(let e=0;e<t.indicies.length;e+=3){const i=S[t.indicies[e+0]],s=S[t.indicies[e+1]],n=S[t.indicies[e+2]];this.vertexPostProcess(i,s,n)}}vertexShading(t){for(let e=0;e<t.length;e++){S[e].vertex=t[e],S[e].vsOutput=this.shader.vertexShader(t[e]);const i=S[e].vsOutput.clip_space_position;S[e].ndc_position.x=i.x/i.w,S[e].ndc_position.y=i.y/i.w,S[e].ndc_position.z=i.z/i.w;const s=S[e].ndc_position;S[e].screen_space_position.x=(s.x+1)*.5*(this.width-1),S[e].screen_space_position.y=(1-(s.y+1)*.5)*(this.height-1),S[e].screen_space_position.z=s.z}}vertexPostProcess(t,e,i){const s=t.vsOutput.clip_space_position,n=e.vsOutput.clip_space_position,a=i.vsOutput.clip_space_position,r=s.w<=0||s.z<-s.w||s.z>s.w,c=n.w<=0||n.z<-n.w||n.z>n.w,o=a.w<=0||a.z<-a.w||a.z>a.w;if(!(r&&c&&o)&&!r&&!c&&!o){const l=t.ndc_position,f=e.ndc_position,w=i.ndc_position;if(f.substract(l).cross(w.substract(l)).z>0)return;this.rasterization(t,e,i)}}rasterization(t,e,i){const s=t.screen_space_position,n=e.screen_space_position,a=i.screen_space_position;if(this.WIREFRAME)this.rasterizeLine(s,n),this.rasterizeLine(n,a),this.rasterizeLine(a,s);else{const r=Math.min(s.x,n.x,a.x),c=Math.max(s.x,n.x,a.x),o=Math.min(s.y,n.y,a.y),l=Math.max(s.y,n.y,a.y),f=Math.floor(Math.max(0,Math.min(this.width,r))),w=Math.floor(Math.max(0,Math.min(this.width,c))),m=Math.ceil(Math.max(0,Math.min(this.height,o))),M=Math.ceil(Math.max(0,Math.min(this.height,l)));for(let C=m;C<=M;C++)for(let R=f;R<=w;R++){const j=new d;j.x=R,j.y=C;const b=this.getBarycentricCoords(s,n,a,j);if(j.z=b.x*s.z+b.y*n.z+b.z*a.z,b.x>=0&&b.y>=0&&b.z>=0){const E=this._calculateFragmentShaderInput(t,e,i,b);this.fragmentShading(j,E)}}}}_calculateFragmentShaderInput(t,e,i,s){const n=t.vsOutput.clip_space_position,a=e.vsOutput.clip_space_position,r=i.vsOutput.clip_space_position,c={};for(let o in t.vsOutput){const l=t.vsOutput[o],f=e.vsOutput[o],w=i.vsOutput[o];if(l instanceof p&&f instanceof p&&w instanceof p){const m=s.x/n.w+s.y/a.w+s.z/r.w;c[o]=new d((s.x*(l.x/n.w)+s.y*(f.x/a.w)+s.z*(w.x/r.w))/m,(s.x*(l.y/n.w)+s.y*(f.y/a.w)+s.z*(w.y/r.w))/m)}else if(l instanceof d&&f instanceof d&&w instanceof d){const m=s.x/n.w+s.y/a.w+s.z/r.w;c[o]=new d((s.x*(l.x/n.w)+s.y*(f.x/a.w)+s.z*(w.x/r.w))/m,(s.x*(l.y/n.w)+s.y*(f.y/a.w)+s.z*(w.y/r.w))/m,(s.x*(l.z/n.w)+s.y*(f.z/a.w)+s.z*(w.z/r.w))/m)}}return c}fragmentShading(t,e){const i=t.y*this.width+t.x,s=i*4,a=this.shader.fragmentShader(e).fragment_color;this.zBuffer[i]<t.z||(this.zBuffer[i]=t.z,this.buffer[s+0]=a.red,this.buffer[s+1]=a.green,this.buffer[s+2]=a.blue,this.buffer[s+3]=a.alpha)}rasterizeLine(t,e,i=new y(0,0,0)){let s=Math.floor(t.x),n=Math.floor(t.y),a=Math.floor(e.x),r=Math.floor(e.y);const c=Math.abs(a-s),o=s<a?1:-1,l=-Math.abs(r-n),f=n<r?1:-1;let w=c+l;for(;n<this.height&&s<this.width;){const m=(n*this.width+s)*4;if(this.buffer[m+0]=i.red,this.buffer[m+1]=i.green,this.buffer[m+2]=i.blue,this.buffer[m+3]=i.alpha,s===a&&n===r)break;const M=2*w;if(M>=l){if(s===a)break;w=w+l,s=s+o}if(M<=c){if(n===r)break;w=w+c,n=n+f}}}drawPoint(t){const i=this.shader.vertexShader(t).clip_space_position;if(i.w<=0||i.x<-i.w||i.x>i.w||i.y<-i.w||i.y>i.w||i.z<-i.w||i.z>i.w)return;const s=new d(i.x/i.w,i.y/i.w,i.z/i.w),n=new p(Math.floor((s.x+1)*.5*(this.width-1)),Math.floor((1-(s.y+1)*.5)*(this.height-1))),a=(n.y*this.width+n.x)*4;this.shader.fragmentShader({});const r=new y(255,0,0);this.buffer[a+0]=r.red,this.buffer[a+1]=r.green,this.buffer[a+2]=r.blue,this.buffer[a+3]=r.alpha}switchBuffer(){this.clearDepthBuffer();const t=performance.now();return this.deltaTime=(t-this.lastTime)/1e3,this.fps=1/this.deltaTime,this.frameCount+=1,this.lastTime=t,this.buffer}}async function gt(u){const t=await fetch(u);if(!t.ok)throw new Error(`ObjLoader could not fine file at ${u}. Please check your path.`);return t}async function yt(u){const t=u==null?void 0:u.split(`
`),e=[],i=[],s=[],n=[];for(const c of t){const o=c.trim(),[l,...f]=o.split(/\s+/);switch(l){case"v":e.push(f.map(parseFloat));break;case"vt":n.push(f.map(Number));break;case"vn":s.push(f.map(parseFloat));break;case"f":i.push(f);break}}const a={},r={vertices:[],indices:[]};for(let c of i)for(let o of c)if(o=o.trim(),a[o]!==void 0)r.indices.push(a[o]);else{const[l,f,w]=o.split("/").map(m=>Number(m));r.vertices.push({position:e[l-1],textCoord:n==null?void 0:n[f-1],normal:s==null?void 0:s[w-1]}),r.indices.push(r.vertices.length-1),a[o]=r.vertices.length-1}return r}async function xt(u){const e=await(await gt(u)).text();if(e.length===0)throw new Error(`${u} File is empty.`);return yt(e)}class zt extends G{constructor(){super(...arguments);h(this,"transform",new x);h(this,"transformInverseTranspose",new x);h(this,"viewProjectionMatrix",new x);h(this,"fragColor",new y(0,0,0,255));h(this,"texture");h(this,"viewProjectionMIT",new x);h(this,"lightPosition",new d(0,5,-15));h(this,"lightColor",new y(1,0,0))}vertexShader(e){const i=new _(e.position).multiply(this.transform.multiply(this.viewProjectionMatrix)),s=new _(e.position).multiply(this.transform),n=new _(e.normal).multiply(this.transformInverseTranspose);return{clip_space_position:i,normal_coords:new d(n),frag_position:new d(s)}}fragmentShader({texture_coords:e,normal_coords:i,frag_position:s}){var a,r;let n=this.fragColor;if(this.texture&&e){const c=new p(Math.floor(e.x*((a=this.texture)==null?void 0:a.width)),Math.floor(e.y*((r=this.texture)==null?void 0:r.height))),o=(c.y*this.texture.width+c.x)*4;n=new y(this.texture.data[o+0],this.texture.data[o+1],this.texture.data[o+2],this.texture.data[o+3])}if(i&&s){const o=new d(10,0,0).multiply(.004),l=i.normalized(),f=this.lightPosition.substract(s).normalized(),w=Math.max(f.dot(l),0),m=this.lightColor.toVec3().multiply(w),M=o.add(m);n=y.fromVec(M.multiply(n.toVec3()),n.alpha)}return{fragment_color:n}}}new T(0,0);new T(0,0);let J=new T(0,0);new T(0,0);const I=class I{constructor(){h(this,"renderer",new pt(100,100));h(this,"shader",new zt);h(this,"camera",new q(q.Types.Perspective));h(this,"nextFrameId",0);h(this,"isRun",!1);h(this,"renderCallback",(t,e)=>console.log(e.fps));this.renderer.WIREFRAME=!1,this.camera.setPosition(new d(0,0,-4)),xt("./assets/african_head.obj").then(t=>{J=T.fromArrays(t.vertices.map(e=>new A(e.position,e.textCoord,e.normal)),t.indices)}),this.initControls()}static getInstance(){return I.instance||(I.instance=new I),I.instance}initControls(){document.addEventListener("wheel",t=>{const e=t.deltaY/1e3;this.camera.move(new d(0,0,e))}),document.addEventListener("keydown",t=>{const e=.5*this.renderer.deltaTime;t.key==="w"&&this.camera.move(new d(0,e,0)),t.key==="s"&&this.camera.move(new d(0,-e,0)),t.key==="a"&&this.camera.move(new d(-e,0,0)),t.key==="d"&&this.camera.move(new d(e,0,0)),t.key==="e"&&this.camera.rotate(new d(0,-100*this.renderer.deltaTime,0)),t.key==="q"&&this.camera.rotate(new d(0,100*this.renderer.deltaTime,0)),t.key==="1"&&this.camera.rotate(new d(-100*this.renderer.deltaTime,0,0)),t.key==="2"&&this.camera.rotate(new d(100*this.renderer.deltaTime,0,0))})}setViewportSize(t,e){this.camera.aspect=t/e,this.renderer.setViewportSize(t,e)}setRenderCallback(t){this.renderCallback=t}start(){this.isRun||(this.shader.transform=x.fromQuaternion(P.fromEuler(new d(0,180,0))),this.isRun=!0,this.run())}run(){this.isRun&&(this.renderer.fillBuffer(new y(0,0,0,0)),this.renderer.shader=this.shader,this.shader.transform=this.shader.transform.multiply(x.fromQuaternion(P.fromEuler(0,5*this.renderer.deltaTime,0))),this.shader.transformInverseTranspose=this.shader.transform.inverse().transpose(),this.shader.lightPosition=new d(new _(this.shader.lightPosition).multiply(x.fromQuaternion(P.fromEuler(0,60*this.renderer.deltaTime,0)))),this.shader.viewProjectionMatrix=this.camera.getViewProjectionMatrix(),this.shader.fragColor=new y(255,0,0),this.shader.fragColor=new y(255,0,0),this.renderer.drawMesh(J),this.renderCallback(this.renderer.switchBuffer(),this.renderer),cancelAnimationFrame(this.nextFrameId),this.nextFrameId=requestAnimationFrame(()=>this.run()))}stop(){this.isRun=!1,cancelAnimationFrame(this.nextFrameId)}};h(I,"instance");let H=I;const L=H.getInstance();HTMLElement.prototype.setTo=function(u){return K(this,u)};function K(u,t){for(let e in t){const i=t[e];typeof i=="object"?K(u[e],i):u[e]=i}return u}function k(u,t){const e=document.createElement(u);return e.setTo(t),e}const Y=2,N=16*25,U=9*25,W=N*Y,B=U*Y;function Ot(u){const t=k("canvas",{width:W,height:B,style:{width:`${W}px`,height:`${B}px`}}),e=k("div",{innerText:"0 fps, 0 total frame count"});function i(r,c){if(t&&e){const o=new ImageData(mt(r,N,U,Y),W,B),l=t.getContext("2d");l==null||l.putImageData(o,0,0),e.innerText=`${c.fps.toFixed()} fps, ${c.frameCount} total frame count`}}L.setViewportSize(N,U),L.setRenderCallback(i);const s=k("button",{onclick:function(){L.isRun?L.stop():L.start(),L.isRun?this.innerText="Stop":this.innerText="Start"},innerText:"Start"}),n=k("button",{innerText:"Line / Fill",onclick:()=>{L.renderer.WIREFRAME=!L.renderer.WIREFRAME}}),a=k("pre",{innerText:"Move camera with A, W, S, D keys and rotate with Q, E, 1, 2."});u.appendChild(e),u.appendChild(t),u.appendChild(s),u.appendChild(n),u.appendChild(a),setTimeout(()=>{s.click()},250)}document.querySelector("#app").innerHTML=`
  <div id="root"></div>
`;Ot(document.querySelector("#root"));
